name: TypeScript Coverage

on: push

jobs:
  ts-coverage:
    name: TypeScript Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          yarn install --frozen-lockfile
          yarn global add typescript typescript-coverage-report type-coverage
          sudo apt-get update
          sudo apt-get install python3-html2text

      - name: TypeScript Coverage
        run: yarn run ts-coverage

  output:
    name: Output to summary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: ["./apps/frontend"]
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Convert HTML to Markdown and output to summary
        run: |
          workspace=${{ matrix.workspace }}
          echo "# ${{ matrix.workspace }}" >> $GITHUB_STEP_SUMMARY
          html2markdown --ignore-links ${{ matrix.workspace }}/coverage-ts/index.html | sed '/# TypeScript coverage report/d' >> $GITHUB_STEP_SUMMARY
